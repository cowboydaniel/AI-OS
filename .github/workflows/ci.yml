name: CI and Release Checks

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  lint-and-packages:
    name: Lint scripts and build packages
    runs-on: ubuntu-22.04
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install lint/build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck rsync dpkg-dev

      - name: Run ShellCheck
        run: |
          mapfile -t scripts < <(git ls-files '*.sh')
          if (( ${#scripts[@]} )); then
            shellcheck "${scripts[@]}"
          else
            echo "No shell scripts detected."
          fi

      - name: Build Debian packages
        run: ./packages/scripts/build-debs.sh

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aetheros-debs
          path: packages/dist/*.deb

  lfs-guard:
    name: Enforce Git LFS rules
    runs-on: ubuntu-22.04
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Validate LFS tracking for large files
        run: ./scripts/ci/check-lfs.sh

  iso-smoke:
    name: ISO smoke test
    runs-on: ubuntu-22.04
    needs:
      - lint-and-packages
      - lfs-guard
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install remaster dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso isolinux syslinux-utils rsync

      - name: Run remaster smoke test
        run: ./build/iso/scripts/smoke-test.sh --workdir build/iso/.ci-smoke

      - name: Upload smoke test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aetheros-iso-smoke
          path: |
            build/iso/.ci-smoke/output/aetheros-smoke.iso
            build/iso/.ci-smoke/output/aetheros-smoke.iso.SHA256SUMS
