name: Build and Publish AetherOS ISO

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 6 * * 1" # Mondays at 06:00 UTC

jobs:
  build-iso-release:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      VERSION: "21.3"
      EDITION: "cinnamon"
      RELEASE_PREFIX: "aetheros"
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set build paths
        id: paths
        run: |
          ISO_NAME="linuxmint-${VERSION}-${EDITION}-64bit.iso"
          WORKDIR="${RUNNER_TEMP}/aetheros-work"
          OUTPUT_NAME="${RELEASE_PREFIX}-${VERSION}-${EDITION}.iso"

          echo "ISO_URL=https://mirrors.edge.kernel.org/linuxmint/stable/${VERSION}/${ISO_NAME}" >> "$GITHUB_ENV"
          echo "ISO_PATH=${WORKDIR}/${ISO_NAME}" >> "$GITHUB_ENV"
          echo "WORKDIR=${WORKDIR}" >> "$GITHUB_ENV"
          echo "OUTPUT_ISO=${WORKDIR}/${OUTPUT_NAME}" >> "$GITHUB_ENV"
          echo "CHECKSUMS=${WORKDIR}/${OUTPUT_NAME}.SHA256SUMS" >> "$GITHUB_ENV"

          TAG="${RELEASE_PREFIX}-${VERSION}-${EDITION}-$(date -u +%Y%m%d)-${GITHUB_RUN_NUMBER}"
          echo "RELEASE_TAG=${TAG}" >> "$GITHUB_ENV"
          echo "RELEASE_NAME=AetherOS ${VERSION} ${EDITION} ISO (${TAG})" >> "$GITHUB_ENV"

      - name: Install ISO tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y xorriso syslinux-utils isolinux bsdtar tree

      - name: Download base Linux Mint ISO
        run: |
          mkdir -p "${WORKDIR}"
          echo "Downloading ${ISO_URL}"
          curl -L "${ISO_URL}" -o "${ISO_PATH}"

      - name: Apply AetherOS remaster patches
        run: |
          chmod +x build/iso/scripts/remaster.sh
          ./build/iso/scripts/remaster.sh \
            --iso "${ISO_PATH}" \
            --workdir "${WORKDIR}" \
            --output "${OUTPUT_ISO}" \
            --volume "AETHEROS"

      - name: Generate checksums
        run: |
          chmod +x build/iso/scripts/generate_checksums.sh
          ./build/iso/scripts/generate_checksums.sh \
            --iso "${OUTPUT_ISO}" \
            --manifest "${CHECKSUMS}"

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          body: |
            Automated AetherOS remaster built from Linux Mint ${{ env.VERSION }} ${{ env.EDITION }}.
            Includes bundled AetherOS payload, branding hooks, and installer defaults.

            Assets:
            - ${{ env.OUTPUT_ISO }}
            - ${{ env.CHECKSUMS }}
          files: |
            ${{ env.OUTPUT_ISO }}
            ${{ env.CHECKSUMS }}
          draft: false
          prerelease: false

      - name: Summarize release
        run: |
          echo "## Release created" >> "$GITHUB_STEP_SUMMARY"
          echo "- Tag: ${RELEASE_TAG}" >> "$GITHUB_STEP_SUMMARY"
          echo "- ISO: $(basename "${OUTPUT_ISO}")" >> "$GITHUB_STEP_SUMMARY"
          echo "- Checksums: $(basename "${CHECKSUMS}")" >> "$GITHUB_STEP_SUMMARY"
